on:
  workflow_call:
    inputs:
      runs-on:
        description: Platform to execute on
        type: string
        default: ubuntu-latest
        required: false
      namespace:
        description: Kubernetes namespace
        type: string
        required: true
      environment:
        required: true
        type: string
      secrets_list:
        required: true
        type: string
      secrets_name:
        required: true
        type: string

jobs:
  build:
    runs-on: ${{ inputs.runs-on }}
    environment: ${{ inputs.environment }}
    steps:
      - name: 'Setup: Git checkout'
        uses: actions/checkout@a12a3943b4bdde767164f792f33f40b04645d846

      - name: 'Setup: Configure AWS credentials'
        uses: aws-actions/configure-aws-credentials@05b148adc31e091bafbaf404f745055d4d3bc9d2
        with:
          aws-access-key-id: ${{ secrets.aws_access_key_id_nonprod_app_deploy }}
          aws-secret-access-key: ${{ secrets.aws_secret_access_key_nonprod_app_deploy }}
          aws-region: eu-west-1

      # TODO: replace "secrets.aws_access_key_id_nonprod_app_deploy" with an input based on target cluster
      - name: 'Get Kubeconf EKS'
        run: |
          aws eks update-kubeconfig --region eu-west-1 --name ${{ secrets.aws_eks_name_nonprod }}

      - name: getsecrets
        env: 
          input_json: ${{ toJson(secrets) }}
          secrets_list: ${{ inputs.secrets_list }}
          environment: ${{ inputs.environment }}
          namespace: ${{ inputs.namespace }}
          k8secname: ${{ inputs.secrets_name }}
        run: |
          IFS=',' read -ra secrets_array <<< "$secrets_list"
          create=("kubectl" "create" "-n $namespace" "secret" "generic" "$k8secname")
          delete=("kubectl" "delete" "-n $namespace" "secret" "--ignore-not-found" "$k8secname")
          for secret_key in "${secrets_array[@]}"; do
            if [[ $input_json == *"$secret_key"* ]]; then
              secret_value=$(echo "$input_json" | jq -r ".$secret_key")
              create+=("--from-literal=""$secret_key=$secret_value")
            fi
          done
          echo "${create[@]}"
          ${delete[@]}
          ${create[@]}

